<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>终末地基质计算器</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
            .shadow-hover {
                @apply transition-all;
            }
            .shadow-hover:hover {
                @apply shadow-lg transform -translate-y-1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="text-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">基质计算器</h1>
                <p class="text-gray-600">选择目标武器，获取最优的淤积点和词条选择</p>
            </div>
            <div class="max-w-md mx-auto">
                <label for="main-weapon-select" class="block text-sm font-medium text-gray-700 mb-1">主刷武器（可选）</label>
                <select id="main-weapon-select" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">-- 不指定主刷武器 --</option>
                </select>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- 左侧面板：武器选择 -->
            <div class="w-full lg:w-1/3 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-shield mr-2 text-primary"></i>武器选择
                </h2>
                <div class="mb-4">
                    <div class="flex gap-2">
                        <select id="rarity-filter" class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="all">全部稀有度</option>
                            <option value="6">6星</option>
                            <option value="5">5星</option>
                        </select>
                        <select id="type-filter" class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="all">全部类型</option>
                            <option value="单手剑">单手剑</option>
                            <option value="双手剑">双手剑</option>
                            <option value="长柄武器">长柄武器</option>
                            <option value="手铳">手铳</option>
                            <option value="施术单元">施术单元</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <select id="base-attribute-filter" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary mb-2">
                        <option value="all">全部基础属性</option>
                    </select>
                    <select id="additional-attribute-filter" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary mb-2">
                        <option value="all">全部附加属性</option>
                    </select>
                    <select id="skill-attribute-filter" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">全部技能属性</option>
                    </select>
                </div>
                <div class="mb-4 flex gap-2">
                    <button id="select-all-btn" class="w-1/2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-md text-sm transition-all">
                        <i class="fa fa-check-square-o mr-1"></i>全选
                    </button>
                    <button id="clear-selection-btn" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-1 px-2 rounded-md text-sm transition-all">
                        <i class="fa fa-times mr-1"></i>清空选择
                    </button>
                </div>
                <div class="space-y-3 mb-6 max-h-96 overflow-y-auto p-2 border border-gray-200 rounded-md" id="weapon-selection">
                    <!-- 武器选择项将通过JavaScript动态生成 -->
                </div>

                <button id="calculate-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-all flex items-center justify-center">
                    <i class="fa fa-calculator mr-2"></i>计算最优选择
                </button>
            </div>

            <!-- 右侧面板：结果展示 -->
            <div class="w-full lg:w-2/3 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-star mr-2 text-primary"></i>最优词条选择
                </h2>
                
                <div id="results-container" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-2">推荐策略</h3>
                        <div class="grid grid-cols-1 gap-4" id="recommendations-container">
                            <!-- 推荐策略卡片将通过JavaScript动态生成 -->
                        </div>
                    </div>




                </div>

                <div id="empty-results" class="text-center py-12">
                    <i class="fa fa-info-circle text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">请选择武器，然后点击“计算最优选择”</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 武器数据
        const weapons = [
            { id: 1, name: "宏愿", rarity: 6, type: "单手剑", baseAttribute: "敏捷提升", additionalAttribute: "攻击提升", skillAttribute: "附术" },
            { id: 2, name: "不知归", rarity: 6, type: "单手剑", baseAttribute: "意志提升", additionalAttribute: "攻击提升", skillAttribute: "流转" },
            { id: 3, name: "熔铸火焰", rarity: 6, type: "单手剑", baseAttribute: "智识提升", additionalAttribute: "攻击提升", skillAttribute: "夜幕" },
            { id: 4, name: "黯色火炬", rarity: 6, type: "单手剑", baseAttribute: "智识提升", additionalAttribute: "灼热伤害提升", skillAttribute: "附术" },
            { id: 5, name: "扶摇", rarity: 6, type: "单手剑", baseAttribute: "主能力提升", additionalAttribute: "暴击率提升", skillAttribute: "夜幕" },
            { id: 6, name: "热熔切割器", rarity: 6, type: "单手剑", baseAttribute: "意志提升", additionalAttribute: "攻击提升", skillAttribute: "流转" },
            { id: 7, name: "显赫声名", rarity: 6, type: "单手剑", baseAttribute: "主能力提升", additionalAttribute: "物理伤害提升", skillAttribute: "残暴" },
            { id: 8, name: "白夜新星", rarity: 6, type: "单手剑", baseAttribute: "主能力提升", additionalAttribute: "源石技艺强度提升", skillAttribute: "附术" },
            { id: 9, name: "大雷斑", rarity: 6, type: "双手剑", baseAttribute: "力量提升", additionalAttribute: "生命提升", skillAttribute: "医疗" },
            { id: 10, name: "赫拉芬格", rarity: 6, type: "双手剑", baseAttribute: "力量提升", additionalAttribute: "攻击提升", skillAttribute: "迸发" },
            { id: 11, name: "典范", rarity: 6, type: "双手剑", baseAttribute: "主能力提升", additionalAttribute: "攻击提升", skillAttribute: "压制" },
            { id: 12, name: "昔日精品", rarity: 6, type: "双手剑", baseAttribute: "意志提升", additionalAttribute: "生命提升", skillAttribute: "效益" },
            { id: 13, name: "破碎君王", rarity: 6, type: "双手剑", baseAttribute: "力量提升", additionalAttribute: "暴击率提升", skillAttribute: "粉碎" },
            { id: 14, name: "负山", rarity: 6, type: "长柄武器", baseAttribute: "敏捷提升", additionalAttribute: "物理伤害提升", skillAttribute: "效益" },
            { id: 15, name: "骁勇", rarity: 6, type: "长柄武器", baseAttribute: "敏捷提升", additionalAttribute: "物理伤害提升", skillAttribute: "巧技" },
            { id: 16, name: "J.E.T.", rarity: 6, type: "长柄武器", baseAttribute: "主能力提升", additionalAttribute: "攻击提升", skillAttribute: "压制" },
            { id: 17, name: "艺术暴君", rarity: 6, type: "手铳", baseAttribute: "智识提升", additionalAttribute: "暴击率提升", skillAttribute: "切骨" },
            { id: 18, name: "领航者", rarity: 6, type: "手铳", baseAttribute: "智识提升", additionalAttribute: "寒冷伤害提升", skillAttribute: "附术" },
            { id: 19, name: "楔子", rarity: 6, type: "手铳", baseAttribute: "主能力提升", additionalAttribute: "暴击率提升", skillAttribute: "附术" },
            { id: 20, name: "同类相食", rarity: 6, type: "手铳", baseAttribute: "主能力提升", additionalAttribute: "法术提升", skillAttribute: "附术" },
            { id: 21, name: "使命必达", rarity: 6, type: "施术单元", baseAttribute: "意志提升", additionalAttribute: "终结技充能效率提升", skillAttribute: "追袭" },
            { id: 22, name: "沧溟星梦", rarity: 6, type: "施术单元", baseAttribute: "智识提升", additionalAttribute: "治疗效率提升", skillAttribute: "附术" },
            { id: 23, name: "作品：蚀迹", rarity: 6, type: "施术单元", baseAttribute: "意志提升", additionalAttribute: "自然伤害提升", skillAttribute: "压制" },
            { id: 24, name: "爆破单元", rarity: 6, type: "施术单元", baseAttribute: "主能力提升", additionalAttribute: "源石技艺强度提升", skillAttribute: "迸发" },
            { id: 25, name: "遗忘", rarity: 6, type: "施术单元", baseAttribute: "智识提升", additionalAttribute: "法术提升", skillAttribute: "夜幕" },
            { id: 26, name: "骑士精神", rarity: 6, type: "施术单元", baseAttribute: "意志提升", additionalAttribute: "生命提升", skillAttribute: "医疗" },
            // 5星武器
            { id: 27, name: "钢铁余音", rarity: 5, type: "单手剑", baseAttribute: "敏捷提升", additionalAttribute: "物理伤害提升", skillAttribute: "巧技" },
            { id: 28, name: "坚城铸造者", rarity: 5, type: "单手剑", baseAttribute: "智识提升", additionalAttribute: "终结技充能效率提升", skillAttribute: "昂扬" },
            { id: 29, name: "逐鳞3.0", rarity: 5, type: "单手剑", baseAttribute: "力量提升", additionalAttribute: "寒冷伤害提升", skillAttribute: "压制" },
            { id: 30, name: "十二问", rarity: 5, type: "单手剑", baseAttribute: "敏捷提升", additionalAttribute: "攻击提升", skillAttribute: "附术" },
            { id: 31, name: "O.B.J.轻芒", rarity: 5, type: "单手剑", baseAttribute: "敏捷提升", additionalAttribute: "攻击提升", skillAttribute: "流转" },
            { id: 32, name: "仰止", rarity: 5, type: "单手剑", baseAttribute: "敏捷提升", additionalAttribute: "物理伤害提升", skillAttribute: "夜幕" },
            { id: 33, name: "探骊", rarity: 5, type: "双手剑", baseAttribute: "力量提升", additionalAttribute: "终结技充能效率提升", skillAttribute: "迸发" },
            { id: 34, name: "古渠", rarity: 5, type: "双手剑", baseAttribute: "力量提升", additionalAttribute: "源石技艺强度提升", skillAttribute: "残暴" },
            { id: 35, name: "终点之声", rarity: 5, type: "双手剑", baseAttribute: "力量提升", additionalAttribute: "生命提升", skillAttribute: "医疗" },
            { id: 36, name: "O.B.J.重荷", rarity: 5, type: "双手剑", baseAttribute: "力量提升", additionalAttribute: "生命提升", skillAttribute: "效益" },
            { id: 37, name: "嵌合正义", rarity: 5, type: "长柄武器", baseAttribute: "力量提升", additionalAttribute: "终结技充能效率提升", skillAttribute: "残暴" },
            { id: 38, name: "O.B.J.尖峰", rarity: 5, type: "长柄武器", baseAttribute: "意志提升", additionalAttribute: "物理伤害提升", skillAttribute: "附术" },
            { id: 39, name: "向心之引", rarity: 5, type: "长柄武器", baseAttribute: "意志提升", additionalAttribute: "电磁伤害提升", skillAttribute: "压制" },
            { id: 40, name: "作品：众生", rarity: 5, type: "手铳", baseAttribute: "敏捷提升", additionalAttribute: "法术提升", skillAttribute: "附术" },
            { id: 41, name: "O.B.J.迅极", rarity: 5, type: "手铳", baseAttribute: "敏捷提升", additionalAttribute: "终结技充能效率提升", skillAttribute: "迸发" },
            { id: 42, name: "理性告别", rarity: 5, type: "手铳", baseAttribute: "力量提升", additionalAttribute: "灼热伤害提升", skillAttribute: "追袭" },
            { id: 43, name: "悼亡诗", rarity: 5, type: "施术单元", baseAttribute: "智识提升", additionalAttribute: "攻击提升", skillAttribute: "夜幕" },
            { id: 44, name: "莫奈何", rarity: 5, type: "施术单元", baseAttribute: "意志提升", additionalAttribute: "终结技充能效率提升", skillAttribute: "昂扬" },
            { id: 45, name: "迷失荒野", rarity: 5, type: "施术单元", baseAttribute: "智识提升", additionalAttribute: "电磁伤害提升", skillAttribute: "附术" },
            { id: 46, name: "布道自由", rarity: 5, type: "施术单元", baseAttribute: "意志提升", additionalAttribute: "治疗效率提升", skillAttribute: "医疗" },
            { id: 47, name: "O.B.J.术识", rarity: 5, type: "施术单元", baseAttribute: "智识提升", additionalAttribute: "源石技艺强度提升", skillAttribute: "追袭" }
        ];

        // 淤积点数据
        const nodes = [
            {
                id: 1,
                name: "枢纽区",
                availableBaseAttributes: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
                availableAdditionalAttributes: ["攻击提升", "灼热伤害提升", "电磁伤害提升", "寒冷伤害提升", "自然伤害提升", "暴击率提升", "终结技效率提升", "法术伤害提升"],
                availableSkillAttributes: ["强攻", "压制", "追袭", "粉碎", "巧技", "迸发", "流转", "效益"]
            },
            {
                id: 2,
                name: "源石研究园",
                availableBaseAttributes: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
                availableAdditionalAttributes: ["攻击提升", "物理伤害提升", "电磁伤害提升", "寒冷伤害提升", "自然伤害提升", "暴击率提升", "终结技效率提升", "法术伤害提升"],
                availableSkillAttributes: ["压制", "追袭", "昂扬", "巧技", "附术", "医疗", "切骨", "效益"]
            },
            {
                id: 3,
                name: "矿脉源区",
                availableBaseAttributes: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
                availableAdditionalAttributes: ["生命提升", "物理伤害提升", "灼热伤害提升", "寒冷伤害提升", "自然伤害提升", "暴击率提升", "源石技艺提升", "治疗效率提升"],
                availableSkillAttributes: ["强攻", "压制", "巧技", "残暴", "附术", "迸发", "夜幕", "效益"]
            },
            {
                id: 4,
                name: "供能高地",
                availableBaseAttributes: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
                availableAdditionalAttributes: ["攻击提升", "生命提升", "物理伤害提升", "灼热伤害提升", "自然伤害提升", "暴击率提升", "源石技艺提升", "治疗效率提升"],
                availableSkillAttributes: ["追袭", "粉碎", "昂扬", "残暴", "附术", "医疗", "切骨", "流转"]
            },
            {
                id: 5,
                name: "武陵城",
                availableBaseAttributes: ["敏捷提升", "力量提升", "意志提升", "智识提升", "主能力提升"],
                availableAdditionalAttributes: ["攻击提升", "生命提升", "电磁伤害提升", "寒冷伤害提升", "暴击率提升", "终结技效率提升", "法术伤害提升", "治疗效率提升"],
                availableSkillAttributes: ["强攻", "粉碎", "残暴", "医疗", "切骨", "迸发", "夜幕", "流转"]
            }
        ];

        // 当前选中的武器ID列表
        let selectedWeaponIds = [];
        // 计算结果
        let calculationResults = [];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化筛选器
            initializeFilters();
            // 渲染武器选择列表
            renderWeaponSelection();
            // 绑定计算按钮事件
            document.getElementById('calculate-btn').addEventListener('click', calculateOptimalCombinations);
        });

        // 当前选中的主刷武器ID
        let mainWeaponId = null;

        // 初始化筛选器
        function initializeFilters() {
            // 获取所有唯一的属性值
            const baseAttributes = [...new Set(weapons.map(w => w.baseAttribute))].sort();
            const additionalAttributes = [...new Set(weapons.map(w => w.additionalAttribute))].sort();
            const skillAttributes = [...new Set(weapons.map(w => w.skillAttribute))].sort();
            
            // 填充基础属性筛选器
            const baseFilter = document.getElementById('base-attribute-filter');
            baseAttributes.forEach(attr => {
                const option = document.createElement('option');
                option.value = attr;
                option.textContent = attr;
                baseFilter.appendChild(option);
            });
            
            // 填充附加属性筛选器
            const additionalFilter = document.getElementById('additional-attribute-filter');
            additionalAttributes.forEach(attr => {
                const option = document.createElement('option');
                option.value = attr;
                option.textContent = attr;
                additionalFilter.appendChild(option);
            });
            
            // 填充技能属性筛选器
            const skillFilter = document.getElementById('skill-attribute-filter');
            skillAttributes.forEach(attr => {
                const option = document.createElement('option');
                option.value = attr;
                option.textContent = attr;
                skillFilter.appendChild(option);
            });
            
            // 绑定筛选器事件
            baseFilter.addEventListener('change', renderWeaponSelection);
            additionalFilter.addEventListener('change', renderWeaponSelection);
            skillFilter.addEventListener('change', renderWeaponSelection);
            
            // 初始化主刷武器选择器
            initializeMainWeaponSelector();
        }

        // 初始化主刷武器选择器
        function initializeMainWeaponSelector() {
            const mainWeaponSelect = document.getElementById('main-weapon-select');
            
            // 按稀有度和名称排序武器
            const sortedWeapons = [...weapons].sort((a, b) => {
                if (a.rarity !== b.rarity) {
                    return b.rarity - a.rarity; // 6星在前，5星在后
                }
                return a.name.localeCompare(b.name);
            });
            
            // 填充主刷武器选择器
            sortedWeapons.forEach(weapon => {
                const option = document.createElement('option');
                option.value = weapon.id;
                option.textContent = `${weapon.name} (${weapon.rarity}星 ${weapon.type})`;
                mainWeaponSelect.appendChild(option);
            });
            
            // 绑定主刷武器选择事件
            mainWeaponSelect.addEventListener('change', function() {
                mainWeaponId = this.value ? parseInt(this.value) : null;
            });
        }

        // 渲染武器选择列表
        function renderWeaponSelection() {
            const container = document.getElementById('weapon-selection');
            container.innerHTML = '';
            
            // 获取筛选条件
            const rarityFilter = document.getElementById('rarity-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const baseAttributeFilter = document.getElementById('base-attribute-filter').value;
            const additionalAttributeFilter = document.getElementById('additional-attribute-filter').value;
            const skillAttributeFilter = document.getElementById('skill-attribute-filter').value;
            
            // 筛选武器
            const filteredWeapons = weapons.filter(weapon => {
                const rarityMatch = rarityFilter === 'all' || weapon.rarity.toString() === rarityFilter;
                const typeMatch = typeFilter === 'all' || weapon.type === typeFilter;
                const baseAttributeMatch = baseAttributeFilter === 'all' || weapon.baseAttribute === baseAttributeFilter;
                const additionalAttributeMatch = additionalAttributeFilter === 'all' || weapon.additionalAttribute === additionalAttributeFilter;
                const skillAttributeMatch = skillAttributeFilter === 'all' || weapon.skillAttribute === skillAttributeFilter;
                return rarityMatch && typeMatch && baseAttributeMatch && additionalAttributeMatch && skillAttributeMatch;
            });

            filteredWeapons.forEach(weapon => {
                const weaponCard = document.createElement('div');
                weaponCard.className = 'flex items-center p-3 border rounded-md shadow-hover';
                
                // 检查武器是否已选中
                const isChecked = selectedWeaponIds.includes(weapon.id) ? 'checked' : '';
                
                weaponCard.innerHTML = `
                    <input type="checkbox" id="weapon-${weapon.id}" class="weapon-checkbox mr-3 h-5 w-5 text-primary focus:ring-primary" value="${weapon.id}" ${isChecked}>
                    <label for="weapon-${weapon.id}" class="flex-1 cursor-pointer">
                        <div class="font-medium flex items-center">
                            ${weapon.name}
                            <span class="ml-2 text-xs px-2 py-0.5 ${weapon.rarity === 6 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'} rounded-full">${weapon.rarity}星</span>
                            <span class="ml-2 text-xs px-2 py-0.5 bg-gray-100 text-gray-800 rounded-full">${weapon.type}</span>
                        </div>
                        <div class="text-sm text-gray-500">${weapon.baseAttribute} / ${weapon.additionalAttribute} / ${weapon.skillAttribute}</div>
                    </label>
                `;
                container.appendChild(weaponCard);

                // 绑定复选框事件
                const checkbox = weaponCard.querySelector('.weapon-checkbox');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedWeaponIds.push(parseInt(this.value));
                    } else {
                        selectedWeaponIds = selectedWeaponIds.filter(id => id !== parseInt(this.value));
                    }
                });
            });
        }
        
        // 绑定筛选和选择控制事件
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定稀有度筛选事件
            document.getElementById('rarity-filter').addEventListener('change', renderWeaponSelection);
            
            // 绑定类型筛选事件
            document.getElementById('type-filter').addEventListener('change', renderWeaponSelection);
            
            // 绑定全选按钮事件
            document.getElementById('select-all-btn').addEventListener('click', function() {
                // 获取当前筛选条件下的武器
                const rarityFilter = document.getElementById('rarity-filter').value;
                const typeFilter = document.getElementById('type-filter').value;
                const baseAttributeFilter = document.getElementById('base-attribute-filter').value;
                const additionalAttributeFilter = document.getElementById('additional-attribute-filter').value;
                const skillAttributeFilter = document.getElementById('skill-attribute-filter').value;
                
                const filteredWeapons = weapons.filter(weapon => {
                    const rarityMatch = rarityFilter === 'all' || weapon.rarity.toString() === rarityFilter;
                    const typeMatch = typeFilter === 'all' || weapon.type === typeFilter;
                    const baseAttributeMatch = baseAttributeFilter === 'all' || weapon.baseAttribute === baseAttributeFilter;
                    const additionalAttributeMatch = additionalAttributeFilter === 'all' || weapon.additionalAttribute === additionalAttributeFilter;
                    const skillAttributeMatch = skillAttributeFilter === 'all' || weapon.skillAttribute === skillAttributeFilter;
                    return rarityMatch && typeMatch && baseAttributeMatch && additionalAttributeMatch && skillAttributeMatch;
                });
                
                // 清空当前选择
                selectedWeaponIds = [];
                
                // 添加筛选后的所有武器
                filteredWeapons.forEach(weapon => {
                    selectedWeaponIds.push(weapon.id);
                });
                
                // 重新渲染武器选择列表
                renderWeaponSelection();
            });
            
            // 绑定清空选择按钮事件
            document.getElementById('clear-selection-btn').addEventListener('click', function() {
                // 清空当前选择
                selectedWeaponIds = [];
                
                // 重新渲染武器选择列表
                renderWeaponSelection();
            });
        });



        // 计算最优属性组合
        function calculateOptimalCombinations() {
            // 检查是否选择了武器
            if (selectedWeaponIds.length === 0) {
                alert('请至少选择一件武器');
                return;
            }

            // 获取选中的武器
            const selectedWeapons = weapons.filter(weapon => selectedWeaponIds.includes(weapon.id));
            
            // 存储所有淤积点的计算结果
            let allNodeResults = [];
            
            // 遍历所有淤积点，计算每个淤积点的最优组合
            nodes.forEach(node => {
                // 生成当前淤积点的所有可能属性组合
                const allCombinations = generateAllPossibleCombinations(node);
                
                // 计算每个组合的得分
                const nodeResults = [];
                allCombinations.forEach(combination => {
                    let score = 0;
                    const matchedWeapons = [];

                    selectedWeapons.forEach(weapon => {
                        if (isWeaponMatch(weapon, combination, node)) {
                            score++;
                            matchedWeapons.push(weapon);
                        }
                    });

                    if (score > 0) {
                        nodeResults.push({
                            nodeId: node.id,
                            nodeName: node.name,
                            combination,
                            score,
                            matchedWeapons
                        });
                    }
                });
                
                // 将当前淤积点的结果添加到总结果中
                allNodeResults = allNodeResults.concat(nodeResults);
            });

            // 如果指定了主刷武器，只保留包含该武器的组合
            let filteredResults = allNodeResults;
            if (mainWeaponId) {
                filteredResults = allNodeResults.filter(result => 
                    result.matchedWeapons.some(weapon => weapon.id === mainWeaponId)
                );
            }
            
            // 按得分降序排序并取前10个
            calculationResults = filteredResults
                .sort((a, b) => b.score - a.score)
                .slice(0, 10);

            // 显示结果
            displayResults();
        }

        // 生成所有可能的属性组合
        function generateAllPossibleCombinations(node) {
            const combinations = [];
            const baseAttributes = node.availableBaseAttributes;
            const additionalAttributes = node.availableAdditionalAttributes;
            const skillAttributes = node.availableSkillAttributes;
            
            // 生成所有可能的3个基础属性组合
            for (let i = 0; i < baseAttributes.length; i++) {
                for (let j = i + 1; j < baseAttributes.length; j++) {
                    for (let k = j + 1; k < baseAttributes.length; k++) {
                        const selectedBases = [baseAttributes[i], baseAttributes[j], baseAttributes[k]];
                        
                        // 生成选择附加属性的组合
                        additionalAttributes.forEach(attr => {
                            combinations.push({
                                selectedBaseAttributes: selectedBases,
                                selectedAttribute: attr,
                                attributeType: "additional"
                            });
                        });
                        
                        // 生成选择技能属性的组合
                        skillAttributes.forEach(attr => {
                            combinations.push({
                                selectedBaseAttributes: selectedBases,
                                selectedAttribute: attr,
                                attributeType: "skill"
                            });
                        });
                    }
                }
            }
            
            return combinations;
        }

        // 属性名称映射，处理不完全匹配的情况
        const attributeNameMap = {
            "终结技充能效率提升": "终结技效率提升",
            "源石技艺强度提升": "源石技艺提升"
        };

        // 获取标准化的属性名称
        function getNormalizedAttributeName(attrName) {
            return attributeNameMap[attrName] || attrName;
        }

        // 检查属性是否匹配（考虑名称映射）
        function isAttributeMatch(weaponAttr, nodeAttr) {
            const normalizedWeaponAttr = getNormalizedAttributeName(weaponAttr);
            const normalizedNodeAttr = getNormalizedAttributeName(nodeAttr);
            return normalizedWeaponAttr === normalizedNodeAttr;
        }

        // 检查武器是否与属性组合匹配
        function isWeaponMatch(weapon, combination, node) {
            // 检查武器的基础属性是否在用户选择的3个基础属性中
            const baseMatch = combination.selectedBaseAttributes.includes(weapon.baseAttribute);
            
            // 检查武器的附加属性和技能属性是否与用户选择的特定属性匹配
            let attributeMatch = false;
            if (combination.attributeType === "additional") {
                attributeMatch = isAttributeMatch(weapon.additionalAttribute, combination.selectedAttribute);
            } else {
                attributeMatch = isAttributeMatch(weapon.skillAttribute, combination.selectedAttribute);
            }
            
            // 检查剩余属性是否在淤积点的可用属性中
            let remainingMatch = false;
            if (combination.attributeType === "additional") {
                remainingMatch = node.availableSkillAttributes.some(attr => 
                    isAttributeMatch(weapon.skillAttribute, attr)
                );
            } else {
                remainingMatch = node.availableAdditionalAttributes.some(attr => 
                    isAttributeMatch(weapon.additionalAttribute, attr)
                );
            }
            
            // 只有当所有条件都满足时，该组合才能刷取该武器
            return baseMatch && attributeMatch && remainingMatch;
        }

        // 显示计算结果
        function displayResults() {
            // 隐藏空结果提示
            document.getElementById('empty-results').classList.add('hidden');
            // 显示结果容器
            document.getElementById('results-container').classList.remove('hidden');
            
            // 渲染推荐策略卡片
            renderRecommendationsCards();
        }

        // 渲染推荐策略卡片
        function renderRecommendationsCards() {
            const container = document.getElementById('recommendations-container');
            container.innerHTML = '';

            calculationResults.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white border rounded-lg shadow-sm hover:shadow-md transition-all p-4';
                
                // 格式化特定属性显示
                const attributeTypeText = result.combination.attributeType === 'additional' ? '附加' : '技能';
                
                // 获取覆盖武器的名称列表
                const weaponNames = result.matchedWeapons.map(w => w.name).join(', ');
                
                // 简化基础词条显示
                const simplifiedBaseAttributes = result.combination.selectedBaseAttributes.map(attr => {
                    return attr.replace('提升', '');
                }).join(', ');
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-lg text-primary">#${index + 1}</div>
                        <div class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                            ${result.score} 把武器
                        </div>
                    </div>
                    <h4 class="text-md font-semibold mb-2">${result.nodeName}</h4>
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">基础属性:</span>
                            <span class="text-gray-600">${simplifiedBaseAttributes}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">${attributeTypeText}属性:</span>
                            <span class="text-gray-600">${result.combination.selectedAttribute}</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="text-xs text-gray-500">
                            <span class="font-medium">覆盖武器:</span> ${result.matchedWeapons.map(w => `<span class="${w.rarity === 6 ? 'text-red-600' : 'text-yellow-600'}">${w.name}</span>`).join(', ')}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // 渲染推荐策略表格（备用）
        function renderRecommendationsTable() {
            const tableBody = document.getElementById('recommendations-table');
            tableBody.innerHTML = '';

            calculationResults.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // 格式化特定属性显示
                const attributeTypeText = result.combination.attributeType === 'additional' ? '附加' : '技能';
                const attributeText = `${result.combination.selectedAttribute} (${attributeTypeText})`;
                
                // 获取覆盖武器的名称列表
                const weaponNames = result.matchedWeapons.map(w => w.name).join(', ');
                
                // 简化基础词条显示
                const simplifiedBaseAttributes = result.combination.selectedBaseAttributes.map(attr => {
                    return attr.replace('提升', '');
                }).join(', ');
                
                row.innerHTML = `
                    <td class="py-2 px-4 border-b border-gray-200">${index + 1}</td>
                    <td class="py-2 px-4 border-b border-gray-200 font-medium">${result.nodeName}</td>
                    <td class="py-2 px-4 border-b border-gray-200">${simplifiedBaseAttributes}</td>
                    <td class="py-2 px-4 border-b border-gray-200">${result.combination.selectedAttribute}</td>
                `;
                
                // 添加覆盖武器信息行
                const weaponRow = document.createElement('tr');
                weaponRow.className = 'bg-gray-50';
                weaponRow.innerHTML = `
                    <td colspan="4" class="py-1 px-4 text-xs text-gray-600">
                        <i class="fa fa-info-circle mr-1"></i>覆盖武器: ${weaponNames}
                    </td>
                `;
                
                tableBody.appendChild(row);
                tableBody.appendChild(weaponRow);
            });


        }




    </script>
</body>
</html>